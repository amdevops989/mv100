<!-- <!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Shop Demo</title>
  <style>
    body{font-family:sans-serif;margin:20px}
    input{margin:4px}
    button{margin:4px}
    .product{border:1px solid #ddd;padding:8px;margin:6px}
  </style>
</head>
<body>
  <h1>Shop Demo</h1>

  <div id="auth">
    <h3>Signup</h3>
    <input id="su_email" placeholder="email" /> <input id="su_pass" placeholder="password" type="password" />
    <button onclick="signup()">Signup</button>

    <h3>Login</h3>
    <input id="li_email" placeholder="email" /> <input id="li_pass" placeholder="password" type="password" />
    <button onclick="login()">Login</button>
    <div id="who"></div>
  </div>

  <hr/>

  <div id="products">
    <h2>Products</h2>
    <div id="list"></div>
  </div>

  <hr/>

  <div id="cart">
    <h2>Your Cart</h2>
    <div id="cartItems"></div>
    <button onclick="checkout()">Checkout</button>
  </div>

<script>
const API_AUTH = 'http://localhost:3000';
const API_CATALOG = 'http://localhost:3001';
const API_CART = 'http://localhost:3002';
let token = localStorage.getItem('token') || null;

function setToken(t) { token = t; localStorage.setItem('token', t); updateWho(); }

function updateWho() {
  const el = document.getElementById('who');
  if (token) el.innerHTML = '<b>Logged in</b> <button onclick="logout()">Logout</button>';
  else el.innerHTML = '<i>Not logged</i>';
  fetchProducts();
  fetchCart();
}

async function signup(){
  const email = document.getElementById('su_email').value;
  const password = document.getElementById('su_pass').value;
  const res = await fetch(API_AUTH + '/signup', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({email,password})});
  alert((await res.json()).success ? 'Signup ok' : 'Signup failed');
}

async function login(){
  const email = document.getElementById('li_email').value;
  const password = document.getElementById('li_pass').value;
  const res = await fetch(API_AUTH + '/login', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({email,password})});
  const data = await res.json();
  if (data.token){ setToken(data.token); alert('Logged in'); }
  else alert('Login failed');
}

function logout(){ setToken(null); localStorage.removeItem('token'); token = null; updateWho(); }

async function fetchProducts(){
  const res = await fetch(API_CATALOG + '/products');
  const products = await res.json();
  const list = document.getElementById('list');
  list.innerHTML = '';
  products.forEach(p=>{
    const div = document.createElement('div');
    div.className='product';
    div.innerHTML = '<b>'+p.name+'</b> - $'+p.price+' <button onclick="addToCart('+p.id+')">Add to cart</button>';
    list.appendChild(div);
  });
}

async function addToCart(productId){
  if (!token) { alert('login first'); return; }
  await fetch(API_CART + '/cart/add', {
    method:'POST',
    headers: {'Content-Type':'application/json','Authorization':'Bearer '+token},
    body: JSON.stringify({ productId, qty: 1 })
  });
  alert('Added');
  fetchCart();
}

async function fetchCart(){
  const el = document.getElementById('cartItems');
  el.innerHTML = '';
  if (!token){ el.innerText = 'Login to see your cart'; return; }
  const res = await fetch(API_CART + '/cart', { headers: { 'Authorization': 'Bearer '+token }});
  const items = await res.json();
  if (!items || Object.keys(items).length===0) { el.innerText='Cart is empty'; return; }
  for (const k of Object.keys(items)) {
    const d = document.createElement('div');
    d.innerText = 'Product ' + k + ' — Qty: ' + items[k];
    el.appendChild(d);
  }
}

async function checkout(){
  if (!token){ alert('login first'); return; }
  const res = await fetch(API_CART + '/cart/checkout', { method: 'POST', headers: { 'Authorization': 'Bearer '+token }});
  const data = await res.json();
  alert('Checkout: ' + JSON.stringify(data));
  fetchCart();
}

updateWho();
</script>

</body>
</html> -->

<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Shop Demo</title>
    <!-- <style>
    body{font-family:sans-serif;margin:20px}
    input{margin:4px}
    button{margin:4px}
    .product, .order{border:1px solid #ddd;padding:8px;margin:6px}
  </style> -->
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <h1>Shop Demo</h1>

    <div id="auth">
      <h3>Signup</h3>
      <input id="su_email" placeholder="email" />
      <input id="su_pass" placeholder="password" type="password" />
      <button onclick="signup()">Signup</button>

      <h3>Login</h3>
      <input id="li_email" placeholder="email" />
      <input id="li_pass" placeholder="password" type="password" />
      <button onclick="login()">Login</button>
      <div id="who"></div>
    </div>

    <hr />

    <div id="products">
      <h2>Products</h2>
      <div id="list"></div>
    </div>

    <hr />

    <div id="cart">
      <h2>Your Cart</h2>
      <div id="cartItems"></div>
      <button onclick="checkout()">Checkout</button>
    </div>

    <hr />

    <div id="orders">
      <h2>Your Orders</h2>
      <div id="ordersList"></div>
    </div>

    <script>
      const API_AUTH = "http://localhost:3000";
      const API_CATALOG = "http://localhost:3001";
      const API_CART = "http://localhost:3002";
      const API_ORDERS = "http://localhost:3003";
      const API_PAYMENTS = "http://localhost:3004";
      let token = localStorage.getItem("token") || null;

      function setToken(t) {
        token = t;
        localStorage.setItem("token", t);
        updateWho();
      }

      function updateWho() {
        const el = document.getElementById("who");
        if (token)
          el.innerHTML =
            '<b>Logged in</b> <button onclick="logout()">Logout</button>';
        else el.innerHTML = "<i>Not logged</i>";
        fetchProducts();
        fetchCart();
        fetchOrders();
      }

      async function signup() {
        const email = document.getElementById("su_email").value;
        const password = document.getElementById("su_pass").value;
        const res = await fetch(API_AUTH + "/signup", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, password }),
        });
        alert((await res.json()).success ? "Signup ok" : "Signup failed");
      }

      async function login() {
        const email = document.getElementById("li_email").value;
        const password = document.getElementById("li_pass").value;
        const res = await fetch(API_AUTH + "/login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, password }),
        });
        const data = await res.json();
        if (data.token) {
          setToken(data.token);
          alert("Logged in");
        } else alert("Login failed");
      }

      function logout() {
        setToken(null);
        localStorage.removeItem("token");
        token = null;
        updateWho();
      }

      async function fetchProducts() {
        const res = await fetch(API_CATALOG + "/products");
        const products = await res.json();
        const list = document.getElementById("list");
        list.innerHTML = "";
        products.forEach((p) => {
          const div = document.createElement("div");
          div.className = "product";
          div.innerHTML =
            "<b>" +
            p.name +
            "</b> - $" +
            p.price +
            ' <button onclick="addToCart(' +
            p.id +
            ')">Add to cart</button>';
          list.appendChild(div);
        });
      }

      async function addToCart(productId) {
        if (!token) {
          alert("login first");
          return;
        }
        await fetch(API_CART + "/cart/add", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: "Bearer " + token,
          },
          body: JSON.stringify({ productId, qty: 1 }),
        });
        alert("Added");
        fetchCart();
      }

      async function fetchCart() {
        const el = document.getElementById("cartItems");
        el.innerHTML = "";
        if (!token) {
          el.innerText = "Login to see your cart";
          return;
        }
        const res = await fetch(API_CART + "/cart", {
          headers: { Authorization: "Bearer " + token },
        });
        const items = await res.json();
        if (!items || Object.keys(items).length === 0) {
          el.innerText = "Cart is empty";
          return;
        }
        for (const k of Object.keys(items)) {
          const d = document.createElement("div");
          d.innerText = "Product " + k + " — Qty: " + items[k];
          el.appendChild(d);
        }
      }

      async function checkout() {
        if (!token) {
          alert("login first");
          return;
        }
        const res = await fetch(API_CART + "/cart/checkout", {
          method: "POST",
          headers: { Authorization: "Bearer " + token },
        });
        const data = await res.json();
        alert("Checkout: " + JSON.stringify(data));
        fetchCart();
        fetchOrders();
      }

      async function fetchOrders() {
        const el = document.getElementById("ordersList");
        el.innerHTML = "";
        if (!token) {
          el.innerText = "Login to see your orders";
          return;
        }
        const res = await fetch(API_ORDERS + "/orders", {
          headers: { Authorization: "Bearer " + token },
        });
        const orders = await res.json();
        if (!orders || orders.length === 0) {
          el.innerText = "No orders yet";
          return;
        }
        orders.forEach((o) => {
          const d = document.createElement("div");
          d.className = "order";
          d.innerHTML = `Order ${o.id} — $${o.amount} — Status: ${o.status} <button onclick="pay(${o.id}, ${o.amount})">Pay</button>`;
          el.appendChild(d);
        });
      }

      async function pay(orderId, amount) {
        if (!token) {
          alert("login first");
          return;
        }
        const res = await fetch(API_PAYMENTS + "/payments", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: "Bearer " + token,
          },
          body: JSON.stringify({ orderId, amount }),
        });
        const data = await res.json();
        alert("Payment: " + JSON.stringify(data));
        fetchOrders();
      }

      updateWho();
    </script>
  </body>
</html>
